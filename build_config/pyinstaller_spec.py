# -*- coding: utf-8 -*-
"""
PyInstaller ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

Task 13: PyInstallerå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
WabiMailã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚
"""

import os
import sys
import platform
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’å–å¾—
PROJECT_ROOT = Path(__file__).parent.parent
SRC_DIR = PROJECT_ROOT / "src"
RESOURCES_DIR = PROJECT_ROOT / "resources"
ASSETS_DIR = RESOURCES_DIR / "assets"

# ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥è¨­å®š
PLATFORM = platform.system()
IS_WINDOWS = PLATFORM == "Windows"
IS_MACOS = PLATFORM == "Darwin"
IS_LINUX = PLATFORM == "Linux"

def create_spec_content():
    """PyInstaller specãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç”Ÿæˆ"""
    
    # ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
    if IS_WINDOWS:
        icon_file = str(ASSETS_DIR / "icons" / "wabimail.ico")
    elif IS_MACOS:
        icon_file = str(ASSETS_DIR / "icons" / "wabimail.icns")
    else:
        icon_file = str(ASSETS_DIR / "icons" / "wabimail.png")
    
    # å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
    datas = [
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
        (str(PROJECT_ROOT / "config.yaml"), "config"),
        # ã‚¢ã‚»ãƒƒãƒˆ
        (str(ASSETS_DIR), "assets"),
        # è¨¼æ˜æ›¸ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        (str(PROJECT_ROOT / "credentials.json"), ".") if (PROJECT_ROOT / "credentials.json").exists() else None,
    ]
    
    # Noneã‚’é™¤å¤–
    datas = [d for d in datas if d is not None]
    
    # éš ã—ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
    hiddenimports = [
        "tkinter",
        "tkinter.ttk",
        "tkinter.messagebox",
        "tkinter.filedialog",
        "tkinter.scrolledtext",
        "PIL",
        "PIL.Image",
        "PIL.ImageTk",
        "cryptography",
        "cryptography.fernet",
        "yaml",
        "pyyaml",
        "sqlite3",
        "email",
        "email.mime",
        "email.mime.text",
        "email.mime.multipart",
        "email.mime.base",
        "imaplib",
        "smtplib",
        "poplib",
        "google.auth",
        "google.auth.transport.requests",
        "google_auth_oauthlib",
        "google_auth_oauthlib.flow",
        "googleapiclient",
        "googleapiclient.discovery",
        "requests",
        "urllib3",
        "certifi",
    ]
    
    spec_content = f'''# -*- coding: utf-8 -*-
# PyInstaller spec file for WabiMail
# Generated by build_config/pyinstaller_spec.py

import sys
import os
from pathlib import Path

block_cipher = None

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
APP_NAME = "WabiMail"
APP_VERSION = "1.0.0"
APP_DESCRIPTION = "ä¾˜ã³å¯‚ã³ã®ç¾å­¦ã‚’ä½“ç¾ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"
APP_AUTHOR = "WabiMail Development Team"
APP_COPYRIGHT = "Copyright (C) 2025 WabiMail Development Team"

a = Analysis(
    ['{str(PROJECT_ROOT / "src" / "main.py")}'],
    pathex=['{str(PROJECT_ROOT)}', '{str(SRC_DIR)}'],
    binaries=[],
    datas={datas},
    hiddenimports={hiddenimports},
    hookspath=[],
    hooksconfig={{}},
    runtime_hooks=[],
    excludes=[
        'matplotlib',
        'numpy',
        'pandas',
        'scipy',
        'pytest',
        'jupyterlab',
        'notebook',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

# ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥è¨­å®š
if sys.platform == "win32":
    # Windowsç”¨è¨­å®š
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        [],
        name='WabiMail',
        debug=False,
        bootloader_ignore_signals=False,
        strip=False,
        upx=True,
        upx_exclude=[],
        runtime_tmpdir=None,
        console=False,  # GUIã‚¢ãƒ—ãƒªãªã®ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãªã—
        disable_windowed_traceback=False,
        argv_emulation=False,
        target_arch=None,
        codesign_identity=None,
        entitlements_file=None,
        icon='{icon_file}',
        version_file=None,  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¾Œã§è¿½åŠ å¯èƒ½ï¼‰
    )
    
elif sys.platform == "darwin":
    # macOSç”¨è¨­å®š
    exe = EXE(
        pyz,
        a.scripts,
        [],
        exclude_binaries=True,
        name='WabiMail',
        debug=False,
        bootloader_ignore_signals=False,
        strip=False,
        upx=True,
        console=False,
        disable_windowed_traceback=False,
        argv_emulation=False,
        target_arch=None,
        codesign_identity=None,
        entitlements_file=None,
        icon='{icon_file}',
    )
    
    coll = COLLECT(
        exe,
        a.binaries,
        a.zipfiles,
        a.datas,
        strip=False,
        upx=True,
        upx_exclude=[],
        name='WabiMail',
    )
    
    app = BUNDLE(
        coll,
        name='WabiMail.app',
        icon='{icon_file}',
        bundle_identifier='com.wabimail.app',
        version=APP_VERSION,
        info_plist={{
            'CFBundleName': APP_NAME,
            'CFBundleDisplayName': APP_NAME,
            'CFBundleGetInfoString': APP_DESCRIPTION,
            'CFBundleIdentifier': 'com.wabimail.app',
            'CFBundleVersion': APP_VERSION,
            'CFBundleShortVersionString': APP_VERSION,
            'NSHighResolutionCapable': 'True',
            'NSHumanReadableCopyright': APP_COPYRIGHT,
            'NSRequiresAquaSystemAppearance': 'False',  # ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
            'LSMinimumSystemVersion': '10.13.0',
        }},
    )
    
else:
    # Linuxç”¨è¨­å®š
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        [],
        name='wabimail',
        debug=False,
        bootloader_ignore_signals=False,
        strip=False,
        upx=True,
        upx_exclude=[],
        runtime_tmpdir=None,
        console=False,
        disable_windowed_traceback=False,
        argv_emulation=False,
        target_arch=None,
        codesign_identity=None,
        entitlements_file=None,
        icon='{icon_file}',
    )
'''
    
    return spec_content


def create_runtime_hook():
    """ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰"""
    
    hook_content = '''# -*- coding: utf-8 -*-
"""
PyInstaller ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯
å®Ÿè¡Œæ™‚ã®ç’°å¢ƒè¨­å®šã‚’è¡Œã„ã¾ã™
"""

import os
import sys

# SSLè¨¼æ˜æ›¸ã®è¨­å®šï¼ˆrequestsç”¨ï¼‰
if hasattr(sys, '_MEIPASS'):
    import certifi
    os.environ['SSL_CERT_FILE'] = certifi.where()
    os.environ['REQUESTS_CA_BUNDLE'] = certifi.where()

# Tkinterã®è¨­å®š
if sys.platform == "darwin":
    # macOSã§ã®Tkinterè¨­å®š
    os.environ['TK_SILENCE_DEPRECATION'] = '1'
'''
    
    runtime_hook_path = PROJECT_ROOT / "build_config" / "runtime_hook.py"
    with open(runtime_hook_path, 'w', encoding='utf-8') as f:
        f.write(hook_content)
    
    return str(runtime_hook_path)


def create_version_file():
    """Windowsç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ"""
    
    if not IS_WINDOWS:
        return None
    
    version_content = '''# -*- coding: utf-8 -*-
# Windows version file for WabiMail

VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(1, 0, 0, 0),
    prodvers=(1, 0, 0, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo(
      [
      StringTable(
        u'040904B0',
        [StringStruct(u'CompanyName', u'WabiMail Development Team'),
        StringStruct(u'FileDescription', u'WabiMail - ä¾˜ã³å¯‚ã³ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ'),
        StringStruct(u'FileVersion', u'1.0.0.0'),
        StringStruct(u'InternalName', u'wabimail'),
        StringStruct(u'LegalCopyright', u'Copyright (C) 2025 WabiMail Development Team'),
        StringStruct(u'OriginalFilename', u'WabiMail.exe'),
        StringStruct(u'ProductName', u'WabiMail'),
        StringStruct(u'ProductVersion', u'1.0.0.0')])
      ]), 
    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
  ]
)
'''
    
    version_file_path = PROJECT_ROOT / "build_config" / "version_info.py"
    with open(version_file_path, 'w', encoding='utf-8') as f:
        f.write(version_content)
    
    return str(version_file_path)


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    print("ğŸŒ¸ WabiMail PyInstaller ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ")
    print("=" * 60)
    
    # build_configãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    build_dir = PROJECT_ROOT / "build_config"
    build_dir.mkdir(exist_ok=True)
    
    # specãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    spec_content = create_spec_content()
    spec_file_path = PROJECT_ROOT / "WabiMail.spec"
    
    with open(spec_file_path, 'w', encoding='utf-8') as f:
        f.write(spec_content)
    
    print(f"âœ… Specãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {spec_file_path}")
    
    # ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ä½œæˆ
    runtime_hook = create_runtime_hook()
    print(f"âœ… ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒƒã‚¯ä½œæˆ: {runtime_hook}")
    
    # Windowsç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    if IS_WINDOWS:
        version_file = create_version_file()
        print(f"âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {version_file}")
    
    print()
    print("ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("1. PyInstallerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: pip install pyinstaller")
    print("2. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ: pyinstaller WabiMail.spec")
    print(f"3. å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¯ dist/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã•ã‚Œã¾ã™")
    
    return spec_file_path


if __name__ == "__main__":
    main()