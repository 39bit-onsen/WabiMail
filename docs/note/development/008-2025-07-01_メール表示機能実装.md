# Task 8: ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½å®Ÿè£… - é–‹ç™ºè¨˜éŒ²

**å®Ÿè£…æ—¥**: 2025å¹´7æœˆ1æ—¥  
**ã‚¿ã‚¹ã‚¯**: Task 8: ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ - ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã¨æœ¬æ–‡è¡¨ç¤º  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†

---

## ğŸ¯ ã‚¿ã‚¹ã‚¯æ¦‚è¦

WabiMailã®ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚é«˜åº¦ãªæ©Ÿèƒ½ã‚’æŒã¤2ã¤ã®å°‚ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆMailListã¨MailViewerï¼‰ã‚’ä½œæˆã—ã€MainWindowã«çµ±åˆã™ã‚‹ã“ã¨ã§ã€ç¾ã—ãä½¿ã„ã‚„ã™ã„ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºä½“é¨“ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

---

## ğŸ“¦ å®Ÿè£…ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. **MailList** - é«˜åº¦ãªãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ui/mail_list.py` (700+ lines)
- **æ©Ÿèƒ½**:
  - é«˜é€Ÿãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤º
  - è¤‡æ•°ã‚«ãƒ©ãƒ ã§ã®ã‚½ãƒ¼ãƒˆï¼ˆæ—¥ä»˜ã€é€ä¿¡è€…ã€ä»¶åã€ã‚µã‚¤ã‚ºã€ãƒ•ãƒ©ã‚°ï¼‰
  - é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæœªèª­ã€é‡è¦ã€æ·»ä»˜ã‚ã‚Šã€æ—¥ä»˜ç¯„å›²ã€é€ä¿¡è€…ã€ä»¶åï¼‰
  - ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå¤§é‡ãƒ¡ãƒ¼ãƒ«å¯¾å¿œï¼‰
  - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆè¿”ä¿¡ã€è»¢é€ã€å‰Šé™¤ï¼‰
  - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  - è¤‡æ•°é¸æŠå¯¾å¿œ

### 2. **MailViewer** - ãƒªãƒƒãƒãªãƒ¡ãƒ¼ãƒ«æœ¬æ–‡è¡¨ç¤º
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ui/mail_viewer.py` (800+ lines)
- **æ©Ÿèƒ½**:
  - HTML/ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«è¡¨ç¤º
  - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  - ãƒ¡ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼è©³ç´°è¡¨ç¤º
  - ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆ50%-300%ï¼‰
  - è¿”ä¿¡ãƒ»è»¢é€ãƒ»å‰Šé™¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  - URLè‡ªå‹•ãƒªãƒ³ã‚¯åŒ–
  - å°åˆ·å¯¾å¿œï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### 3. **MainWindowçµ±åˆ** - ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé€£æº
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ui/main_window.py` (æ›´æ–°)
- **æ”¹å–„ç‚¹**:
  - æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®çµ±åˆ
  - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æœ€é©åŒ–
  - ãƒ¡ãƒ¼ãƒ«é¸æŠãƒ»è¡¨ç¤ºãƒ•ãƒ­ãƒ¼ã®æ”¹å–„
  - æ—¢èª­ãƒãƒ¼ã‚¯æ©Ÿèƒ½ã®å®Ÿè£…

---

## ğŸ¨ ä¾˜ã³å¯‚ã³ãƒ‡ã‚¶ã‚¤ãƒ³åŸå‰‡

### UIç¾å­¦ã®å®Ÿè£…
```python
# ä¾˜ã³å¯‚ã³ã‚¹ã‚¿ã‚¤ãƒ«ãƒ†ãƒ¼ãƒ
WABI_SABI_COLORS = {
    "bg": "#fefefe",           # ç´”ç™½ã®èƒŒæ™¯
    "fg": "#333333",           # è½ã¡ç€ã„ãŸæ–‡å­—è‰²
    "select_bg": "#f0f0f0",    # æ§ãˆã‚ãªé¸æŠè‰²
    "border": "#e0e0e0",       # ç¹Šç´°ãªå¢ƒç•Œç·š
    "accent": "#8b7355"        # ä¾˜ã³å¯‚ã³ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²
}
```

### é™ã‹ã§ç¾ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- **æœ€å°é™ã®è£…é£¾**: ä½™è¨ˆãªè¦ç´ ã‚’æ’é™¤
- **è‡ªç„¶ãªè‰²å½©**: ç™½ãƒ»ã‚°ãƒ¬ãƒ¼ãƒ»èŒ¶ç³»ã®å’Œã®è‰²èª¿
- **æµã‚Œã‚‹ã‚ˆã†ãªæ“ä½œ**: ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **é™å¯‚ãªéŸ¿ã**: æ§ãˆã‚ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

---

## ğŸ”§ æŠ€è¡“å®Ÿè£…è©³ç´°

### ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```python
class MailList(ttk.Frame):
    """ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ"""
    
    def set_messages(self, messages: List[MailMessage], folder_name: str = "å—ä¿¡ãƒˆãƒ¬ã‚¤"):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’è¨­å®š"""
        # 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
        self.messages = messages
        self._apply_filters()
        
        # 2. ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
        self._apply_sorting()
        
        # 3. è¡¨ç¤ºæ›´æ–°
        self._update_display()
        
        # 4. çµ±è¨ˆæƒ…å ±æ›´æ–°
        self._update_status_info()
```

### ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 

```python
class MailViewer(ttk.Frame):
    """ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ"""
    
    def display_message(self, message: MailMessage):
        """ãƒ¡ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"""
        if not message:
            self._clear_display()
            return
            
        # 1. ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±è¡¨ç¤º
        self._display_header_info(message)
        
        # 2. æœ¬æ–‡è¡¨ç¤ºï¼ˆHTML/ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•åˆ¤å®šï¼‰
        if message.body_html and self.show_html.get():
            self._display_html_content(message.body_html)
        else:
            self._display_text_content(message.body_text)
        
        # 3. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º
        self._display_attachments(message.attachments)
        
        # 4. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³æ›´æ–°
        self._update_action_buttons(message)
```

### çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
# MainWindowã§ã®çµ±åˆå‡¦ç†
def _on_mail_selection_change(self, selected_messages: List[MailMessage]):
    """ãƒ¡ãƒ¼ãƒ«é¸æŠå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ"""
    if selected_messages:
        self.selected_message = selected_messages[0]
        self.mail_viewer.display_message(self.selected_message)
        
        # æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¢èª­ã«ãƒãƒ¼ã‚¯
        if not self.selected_message.is_read():
            self.selected_message.mark_as_read()
            self.mail_list.refresh_message_display(self.selected_message)
    else:
        self.selected_message = None
        self.mail_viewer.display_message(None)
```

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè£…
```python
def _update_virtual_scroll(self):
    """ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã‚ˆã‚‹é«˜é€Ÿè¡¨ç¤º"""
    visible_start = max(0, self.scroll_top - self.buffer_size)
    visible_end = min(len(self.filtered_messages), 
                     self.scroll_top + self.visible_count + self.buffer_size)
    
    # è¡¨ç¤ºç¯„å›²ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿æç”»
    for i in range(visible_start, visible_end):
        self._render_message_item(i)
```

### 2. é…å»¶èª­ã¿è¾¼ã¿
```python
def _lazy_load_content(self, message: MailMessage):
    """å¤§ããªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é…å»¶èª­ã¿è¾¼ã¿"""
    if len(message.body_html) > self.LAZY_LOAD_THRESHOLD:
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èª­ã¿è¾¼ã¿
        threading.Thread(
            target=self._load_large_content,
            args=(message,),
            daemon=True
        ).start()
```

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
```python
class MessageCache:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚­ãƒ£ãƒƒã‚·ãƒ¥"""
    def __init__(self, max_size: int = 100):
        self._cache = {}
        self._access_order = []
        self.max_size = max_size
    
    def get_rendered_content(self, message_id: str):
        """ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—"""
        if message_id in self._cache:
            self._update_access(message_id)
            return self._cache[message_id]
        return None
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè£…

### çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `test_mail_display_integration.py`

```python
def test_mail_display_integration():
    """ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ"""
    # 1. ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
    messages = create_sample_messages()
    
    # 2. MailListã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
    mail_list = MailList(parent_frame, on_selection_change=callback)
    mail_list.set_messages(messages, "å—ä¿¡ãƒˆãƒ¬ã‚¤")
    
    # 3. MailViewerã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
    viewer = MailViewer(parent_frame, on_reply=reply_callback)
    viewer.display_message(messages[0])
    
    # 4. çµ±åˆå‹•ä½œç¢ºèª
    assert mail_list.get_message_count() == len(messages)
    assert viewer.current_message == messages[0]
```

### ãƒ†ã‚¹ãƒˆçµæœ
```bash
âœ… å…¨17å€‹ã®ãƒ¡ãƒ¼ãƒ«é–¢é€£ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†
âœ… çµ±åˆãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œ
âœ… MainWindowã¨ã®çµ±åˆãŒå®Œäº†
```

---

## ğŸ“ˆ å®Ÿè£…æˆæœ

### æ©Ÿèƒ½çš„æˆæœ
- âœ… **é«˜æ€§èƒ½ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ**: 1000ä»¶ä»¥ä¸Šã®ãƒ¡ãƒ¼ãƒ«é«˜é€Ÿè¡¨ç¤º
- âœ… **ãƒªãƒƒãƒãƒ¡ãƒ¼ãƒ«è¡¨ç¤º**: HTML/ãƒ†ã‚­ã‚¹ãƒˆ/æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ
- âœ… **ç›´æ„Ÿçš„æ“ä½œ**: ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢æ©Ÿèƒ½
- âœ… **ç¾ã—ã„UI**: ä¾˜ã³å¯‚ã³ç¾å­¦ã«åŸºã¥ãè¨­è¨ˆ

### æŠ€è¡“çš„æˆæœ
- âœ… **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ–**: å†åˆ©ç”¨å¯èƒ½ãªè¨­è¨ˆ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
- âœ… **æ‹¡å¼µæ€§**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å¯¾å¿œå¯èƒ½ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- âœ… **ä¿å®ˆæ€§**: æ˜ç¢ºãªè²¬ä»»åˆ†é›¢ã¨ãƒ†ã‚¹ãƒˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
- âœ… **å¿«é©ãªæ“ä½œ**: ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
- âœ… **ç¾ã—ã„è¡¨ç¤º**: èª­ã¿ã‚„ã™ã„ãƒ¡ãƒ¼ãƒ«è¡¨ç¤º
- âœ… **åŠ¹ç‡çš„ä½œæ¥­**: é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆ
- âœ… **ä¾˜ã³å¯‚ã³ä½“é¨“**: é™ã‹ã§å¿ƒåœ°ã‚ˆã„æ“ä½œæ„Ÿ

---

## ğŸ”„ MainWindowçµ±åˆãƒã‚¤ãƒ³ãƒˆ

### æ›´æ–°ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰

1. **`_create_main_layout()`**
   - æ–°ã—ã„MailListã¨MailViewerã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ±åˆ
   - å¾“æ¥ã®Treeviewã¨Textã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ç½®æ›

2. **`_on_mail_selection_change()`**
   - ãƒ¡ãƒ¼ãƒ«é¸æŠæ™‚ã®å‡¦ç†ã‚’æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘ã‘ã«æœ€é©åŒ–
   - æ—¢èª­ãƒãƒ¼ã‚¯æ©Ÿèƒ½ã¨ã®é€£æº

3. **`_update_message_list()`**
   - MailListã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®`set_messages()`ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—

4. **ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç³»ãƒ¡ã‚½ãƒƒãƒ‰**
   - `_on_mail_reply()`, `_on_mail_forward()`, `_on_mail_delete()`
   - æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ

---

## ğŸŒ¸ ä¾˜ã³å¯‚ã³ç¾å­¦ã®å®Ÿç¾

### è¦–è¦šçš„èª¿å’Œ
```python
# é™å¯‚ãªè‰²å½©è¨­è¨ˆ
style.configure("Wabi.Treeview", 
    background="#fefefe",
    foreground="#333333", 
    selectbackground="#f0f0f0",
    fieldbackground="#fefefe"
)

# æ§ãˆã‚ãªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
style.configure("Wabi.TLabel",
    font=("Yu Gothic UI", 9),
    background="#fefefe",
    foreground="#666666"
)
```

### æ“ä½œã®é™å¯‚æ€§
- **æ§ãˆã‚ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: å¤§ã’ã•ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—
- **è‡ªç„¶ãªæµã‚Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€è€ƒã«æ²¿ã£ãŸæ“ä½œãƒ•ãƒ­ãƒ¼
- **ä½™ç™½ã®ç¾**: ååˆ†ãªç©ºé–“ã«ã‚ˆã‚‹è¦–è¦šçš„ä¼‘æ¯
- **ä¸€æœŸä¸€ä¼š**: å„ãƒ¡ãƒ¼ãƒ«ã¨ã®å‡ºä¼šã„ã‚’å¤§åˆ‡ã«ã™ã‚‹è¡¨ç¤º

---

## ğŸ‰ Task 8 å®Œäº†

**ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½**ã®å®Ÿè£…ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- âœ… **Task 8**: ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ â†’ **å®Œäº†**
- ğŸ”œ **Task 9**: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ - G003ä½œæˆç”»é¢ã¨é€ä¿¡å‡¦ç†
- ğŸ”œ **Task 10**: è¨­å®šç”»é¢å®Ÿè£… - G004ä¸€èˆ¬è¨­å®šã¨ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ†ãƒ¼ãƒé©ç”¨

---

**ğŸŒ¸ é™å¯‚ã®ä¸­ã®ç¾ã—ã•ã‚’è¿½æ±‚ã—ã¦**

**WabiMailé–‹ç™ºãƒãƒ¼ãƒ **  
*2025å¹´7æœˆ1æ—¥*