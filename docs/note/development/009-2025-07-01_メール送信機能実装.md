# Task 9: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½å®Ÿè£… - é–‹ç™ºè¨˜éŒ²

**å®Ÿè£…æ—¥**: 2025å¹´7æœˆ1æ—¥  
**ã‚¿ã‚¹ã‚¯**: Task 9: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ - G003ä½œæˆç”»é¢ã¨é€ä¿¡å‡¦ç†  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†

---

## ğŸ¯ ã‚¿ã‚¹ã‚¯æ¦‚è¦

WabiMailã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ï¼ˆG003ï¼‰ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ä¾˜ã³å¯‚ã³ã®ç¾å­¦ã«åŸºã¥ã„ãŸé™ã‹ã§ç¾ã—ã„ãƒ¡ãƒ¼ãƒ«ä½œæˆç’°å¢ƒã‚’æä¾›ã—ã€æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆã€è¿”ä¿¡ã€è»¢é€ã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œãªã©ã®åŒ…æ‹¬çš„ãªé€ä¿¡æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

---

## ğŸ“¦ å®Ÿè£…ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. **ComposeWindow** - ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ui/compose_window.py` (800+ lines)
- **æ©Ÿèƒ½**:
  - ä¾˜ã³å¯‚ã³ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ä½œæˆUI
  - æ–°è¦ãƒ¡ãƒ¼ãƒ«ãƒ»è¿”ä¿¡ãƒ»è»¢é€å¯¾å¿œ
  - HTML/ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
  - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
  - ä¸‹æ›¸ãä¿å­˜ãƒ»è‡ªå‹•ä¿å­˜
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
  - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¯¾å¿œ

### 2. **MainWindowçµ±åˆ** - ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé€ä¿¡æ©Ÿèƒ½çµ±åˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ui/main_window.py` (æ›´æ–°)
- **æ”¹å–„ç‚¹**:
  - ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ»è¿”ä¿¡ãƒ»è»¢é€æ©Ÿèƒ½ã®çµ±åˆ
  - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠçŠ¶æ…‹ã®ç¢ºèª
  - é€ä¿¡å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–

### 3. **SMTPçµ±åˆ** - æ—¢å­˜SMTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®é€£æº
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/mail/smtp_client.py` (ç¢ºèªãƒ»æ´»ç”¨)
- **é€£æºæ©Ÿèƒ½**:
  - MailMessageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã®é€ä¿¡
  - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ
  - HTML/ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œ
  - ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼

---

## ğŸ¨ ä¾˜ã³å¯‚ã³ãƒ‡ã‚¶ã‚¤ãƒ³å®Ÿè£…

### UIç¾å­¦ã®ä½“ç¾
```python
# ä¾˜ã³å¯‚ã³ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
self.wabi_colors = {
    "bg": "#fefefe",           # ç´”ç™½ã®èƒŒæ™¯
    "fg": "#333333",           # å¢¨ã®ã‚ˆã†ãªæ–‡å­—è‰²
    "entry_bg": "#fcfcfc",     # å…¥åŠ›æ¬„ã®èƒŒæ™¯
    "border": "#e0e0e0",       # ç¹Šç´°ãªå¢ƒç•Œç·š
    "accent": "#8b7355",       # ä¾˜ã³å¯‚ã³ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²
    "button_bg": "#f8f8f8",    # ãƒœã‚¿ãƒ³èƒŒæ™¯
    "focus": "#d4c4b0"         # ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è‰²
}

# å’Œã®ç¾æ„è­˜ã«åŸºã¥ããƒ•ã‚©ãƒ³ãƒˆè¨­å®š
self.wabi_fonts = {
    "header": ("Yu Gothic UI", 12, "normal"),
    "body": ("Yu Gothic UI", 11, "normal"),
    "compose": ("Yu Gothic UI", 12, "normal")
}
```

### é™ã‹ã§é›†ä¸­ã§ãã‚‹ç’°å¢ƒ
- **ãƒŸãƒ‹ãƒãƒ«ãªãƒ„ãƒ¼ãƒ«ãƒãƒ¼**: å¿…è¦ãªæ©Ÿèƒ½ã®ã¿ã‚’é…ç½®
- **è‡ªç„¶ãªè‰²å½©**: ç›®ã«å„ªã—ã„è‰²èª¿ã§é•·æ™‚é–“ã®ä½¿ç”¨ã«é…æ…®
- **é©åˆ‡ãªä½™ç™½**: æƒ…å ±ã®æ•´ç†ã¨è¦–è¦šçš„ãªä¼‘æ¯
- **æ§ãˆã‚ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: é‚ªé­”ã«ãªã‚‰ãªã„çŠ¶æ…‹è¡¨ç¤º

---

## ğŸ”§ æŠ€è¡“å®Ÿè£…è©³ç´°

### ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```python
class ComposeWindow:
    """ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, parent, account: Account, 
                 message_type: str = "new",
                 original_message: Optional[MailMessage] = None,
                 on_sent: Optional[Callable] = None):
        """
        ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åˆæœŸåŒ–
        
        Args:
            parent: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
            account: é€ä¿¡ã«ä½¿ç”¨ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
            message_type: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ï¼ˆ"new", "reply", "forward"ï¼‰
            original_message: è¿”ä¿¡ãƒ»è»¢é€å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            on_sent: é€ä¿¡å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        """
        self.parent = parent
        self.account = account
        self.message_type = message_type
        self.original_message = original_message
        self.on_sent = on_sent
        
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çŠ¶æ…‹
        self.is_html_mode = tk.BooleanVar(value=False)
        self.attachments: List[MailAttachment] = []
        self.is_draft_saved = False
        
        # UIæ§‹ç¯‰
        self._create_window()
        self._populate_initial_data()
        self._start_auto_save()
```

### è¿”ä¿¡ãƒ»è»¢é€ã®è‡ªå‹•è¨­å®š

```python
def _populate_initial_data(self):
    """è¿”ä¿¡ãƒ»è»¢é€æ™‚ã®åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š"""
    if not self.original_message:
        return
    
    if self.message_type == "reply":
        # è¿”ä¿¡ã®å ´åˆ
        self.to_entry.insert(0, self.original_message.sender)
        
        # Re:ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
        original_subject = self.original_message.subject
        if not original_subject.startswith("Re:"):
            reply_subject = f"Re: {original_subject}"
        else:
            reply_subject = original_subject
        self.subject_entry.insert(0, reply_subject)
        
        # å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨
        quote_text = self._create_quote_text(self.original_message)
        self.body_text.insert(tk.END, quote_text)
        
    elif self.message_type == "forward":
        # è»¢é€ã®å ´åˆ
        # Fwd:ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
        original_subject = self.original_message.subject
        if not original_subject.startswith("Fwd:"):
            forward_subject = f"Fwd: {original_subject}"
        else:
            forward_subject = original_subject
        self.subject_entry.insert(0, forward_subject)
        
        # è»¢é€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        forward_text = self._create_forward_text(self.original_message)
        self.body_text.insert(tk.END, forward_text)
        
        # å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        for attachment in self.original_message.attachments:
            self.attachments.append(attachment)

def _create_quote_text(self, message: MailMessage) -> str:
    """è¿”ä¿¡ç”¨ã®å¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ"""
    date_str = message.get_display_date().strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M")
    
    quote_text = f"""

{date_str} {message.sender} æ§˜:

"""
    
    # å…ƒã®æœ¬æ–‡ã‚’å¼•ç”¨ç¬¦ä»˜ãã§è¿½åŠ 
    original_body = message.body_text or "[æœ¬æ–‡ãªã—]"
    quoted_lines = []
    for line in original_body.split('\n'):
        quoted_lines.append(f"> {line}")
    
    quote_text += '\n'.join(quoted_lines)
    return quote_text
```

### æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

```python
def _add_attachment(self):
    """æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ """
    file_path = filedialog.askopenfilename(
        title="æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ",
        parent=self.window,
        filetypes=[
            ("ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«", "*.*"),
            ("æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«", "*.pdf *.doc *.docx *.txt"),
            ("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«", "*.jpg *.jpeg *.png *.gif *.bmp"),
            ("è¡¨è¨ˆç®—ãƒ•ã‚¡ã‚¤ãƒ«", "*.xls *.xlsx *.csv"),
            ("åœ§ç¸®ãƒ•ã‚¡ã‚¤ãƒ«", "*.zip *.rar *.7z")
        ]
    )
    
    if file_path:
        try:
            # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
            file_path_obj = Path(file_path)
            file_size = file_path_obj.stat().st_size
            
            # MIMEã‚¿ã‚¤ãƒ—ã‚’æ¨æ¸¬
            import mimetypes
            content_type, _ = mimetypes.guess_type(file_path)
            if not content_type:
                content_type = "application/octet-stream"
            
            # æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            attachment = MailAttachment(
                filename=file_path_obj.name,
                content_type=content_type,
                size=file_size
            )
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            with open(file_path, 'rb') as f:
                attachment.data = f.read()
            
            # æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã«è¿½åŠ 
            self.attachments.append(attachment)
            self._update_attachments_display()
            
            self._update_status(f"ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã—ã¾ã—ãŸ: {attachment.filename}")
            
        except Exception as e:
            logger.error(f"ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã‚¨ãƒ©ãƒ¼: {e}")
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ•ã‚¡ã‚¤ãƒ«ã®æ·»ä»˜ã«å¤±æ•—ã—ã¾ã—ãŸ:\n{e}")

def _get_file_icon(self, content_type: str) -> str:
    """ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—"""
    if content_type.startswith('image/'):
        return "ğŸ–¼ï¸"
    elif content_type.startswith('text/'):
        return "ğŸ“„"
    elif 'pdf' in content_type:
        return "ğŸ“•"
    elif content_type.startswith('audio/'):
        return "ğŸµ"
    elif content_type.startswith('video/'):
        return "ğŸ¬"
    elif any(archive in content_type for archive in ['zip', 'rar', 'tar', 'gz']):
        return "ğŸ“¦"
    else:
        return "ğŸ“"
```

### HTML/ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰

```python
def _toggle_html_mode(self):
    """HTML/ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ"""
    if self.is_html_mode.get():
        # HTMLãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        text_content = self.body_text.get("1.0", tk.END)
        html_content = self._text_to_html(text_content)
        
        # ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’éš ã—ã¦HTMLã‚¨ãƒ‡ã‚£ã‚¿ã‚’è¡¨ç¤º
        self.body_text.master.pack_forget()
        self.html_frame.pack(fill=tk.BOTH, expand=True, padx=4, pady=4)
        
        self.html_editor.delete("1.0", tk.END)
        self.html_editor.insert("1.0", html_content)
        
        self._update_status("ğŸ“ HTMLç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ")
        
    else:
        # ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        html_content = self.html_editor.get("1.0", tk.END)
        text_content = self._html_to_text(html_content)
        
        # HTMLã‚¨ãƒ‡ã‚£ã‚¿ã‚’éš ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        self.html_frame.pack_forget()
        self.body_text.master.pack(fill=tk.BOTH, expand=True, padx=4, pady=4)
        
        self.body_text.delete("1.0", tk.END)
        self.body_text.insert("1.0", text_content)
        
        self._update_status("ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ")

def _text_to_html(self, text: str) -> str:
    """ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¾˜ã³å¯‚ã³ã‚¹ã‚¿ã‚¤ãƒ«ã®HTMLã«å¤‰æ›"""
    import html
    
    # HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    escaped_text = html.escape(text)
    
    # æ”¹è¡Œã‚’HTMLæ”¹è¡Œã«å¤‰æ›
    html_text = escaped_text.replace('\n', '<br>\n')
    
    # ä¾˜ã³å¯‚ã³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    html_content = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {{
            font-family: 'Yu Gothic UI', sans-serif;
            font-size: 12px;
            line-height: 1.6;
            color: #333333;
            background-color: #fefefe;
            margin: 16px;
        }}
    </style>
</head>
<body>
{html_text}
</body>
</html>"""
    
    return html_content
```

### è‡ªå‹•ä¿å­˜ãƒ»ä¸‹æ›¸ãæ©Ÿèƒ½

```python
def _start_auto_save(self):
    """è‡ªå‹•ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹"""
    def auto_save():
        if self.window and self.window.winfo_exists():
            self._save_draft_silently()
            # 5åˆ†å¾Œã«å†å®Ÿè¡Œ
            self.auto_save_timer = self.window.after(300000, auto_save)
    
    # æœ€åˆã®è‡ªå‹•ä¿å­˜ã¯1åˆ†å¾Œ
    self.auto_save_timer = self.window.after(60000, auto_save)

def _save_draft_silently(self):
    """ç„¡éŸ³ã§ä¸‹æ›¸ãã‚’ä¿å­˜ï¼ˆè‡ªå‹•ä¿å­˜ç”¨ï¼‰"""
    try:
        # ä¸‹æ›¸ããƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        draft_data = self._create_message_data()
        
        # å®Ÿéš›ã®ä¿å­˜å‡¦ç†ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        # TODO: ä¸‹æ›¸ãã®æ°¸ç¶šåŒ–å®Ÿè£…
        
        self.is_draft_saved = True
        logger.debug("ä¸‹æ›¸ãã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ")
        
    except Exception as e:
        logger.warning(f"è‡ªå‹•ä¸‹æ›¸ãä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†

```python
def _send_message(self):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"""
    try:
        # å…¥åŠ›æ¤œè¨¼
        if not self._validate_message():
            return
        
        self._update_status("ğŸ“® ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ä¸­...")
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        message_data = self._create_message_data()
        
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é€ä¿¡å‡¦ç†
        def send_in_background():
            try:
                # SMTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
                smtp_client = MailClientFactory.create_send_client(self.account)
                
                if not smtp_client:
                    raise Exception("SMTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
                
                # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                success, result = smtp_client.send_message(message_data)
                
                # UIã‚¹ãƒ¬ãƒƒãƒ‰ã§çµæœã‚’å‡¦ç†
                self.window.after(0, lambda: self._handle_send_result(success, result))
                
            except Exception as e:
                self.window.after(0, lambda: self._handle_send_error(str(e)))
        
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§é€ä¿¡å®Ÿè¡Œ
        threading.Thread(target=send_in_background, daemon=True).start()
        
    except Exception as e:
        logger.error(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
        messagebox.showerror("é€ä¿¡ã‚¨ãƒ©ãƒ¼", f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:\n{e}")

def _validate_message(self) -> bool:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…¥åŠ›æ¤œè¨¼"""
    # å®›å…ˆãƒã‚§ãƒƒã‚¯
    to_addresses = self.to_entry.get().strip()
    if not to_addresses:
        messagebox.showerror("å…¥åŠ›ã‚¨ãƒ©ãƒ¼", "å®›å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        self.to_entry.focus()
        return False
    
    # ä»¶åãƒã‚§ãƒƒã‚¯ï¼ˆç©ºã§ã‚‚è­¦å‘Šã®ã¿ï¼‰
    subject = self.subject_entry.get().strip()
    if not subject:
        result = messagebox.askyesno("ç¢ºèª", "ä»¶åãŒç©ºã§ã™ã€‚ã“ã®ã¾ã¾é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")
        if not result:
            self.subject_entry.focus()
            return False
    
    return True
```

---

## ğŸŒ¸ MainWindowçµ±åˆå®Ÿè£…

### æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½

```python
def _create_new_message(self):
    """æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆ"""
    if not self.current_account:
        messagebox.showwarning(
            "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœªé¸æŠ",
            "ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã¾ãšã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
        )
        return
    
    self._update_status("æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™...")
    
    try:
        from src.ui.compose_window import show_compose_window
        
        def on_message_sent(message):
            """ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
            self._update_status(f"âœ… ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ: {message.subject}")
            logger.info(f"ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: {message.subject}")
        
        # ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        compose_window = show_compose_window(
            parent=self.root,
            account=self.current_account,
            message_type="new",
            on_sent=on_message_sent
        )
        
        if compose_window:
            logger.info("æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã—ãŸ")
            
    except Exception as e:
        logger.error(f"æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n{e}")
```

### è¿”ä¿¡ãƒ»è»¢é€æ©Ÿèƒ½çµ±åˆ

```python
def _on_mail_reply(self, data, reply_all=False):
    """ãƒ¡ãƒ¼ãƒ«è¿”ä¿¡å‡¦ç†"""
    message = data if isinstance(data, MailMessage) else data[0] if data else None
    if not message or not self.current_account:
        return
    
    reply_type = "å…¨å“¡ã«è¿”ä¿¡" if reply_all else "è¿”ä¿¡"
    self._update_status(f"ã€Œ{message.subject}ã€ã«{reply_type}...")
    
    try:
        from src.ui.compose_window import show_compose_window
        
        def on_reply_sent(reply_message):
            """è¿”ä¿¡é€ä¿¡å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
            self._update_status(f"âœ… è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸ: {reply_message.subject}")
            # å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿”ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
            if not message.has_flag(MessageFlag.ANSWERED):
                message.add_flag(MessageFlag.ANSWERED)
                self.mail_list.refresh_message_display(message)
        
        # è¿”ä¿¡ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        compose_window = show_compose_window(
            parent=self.root,
            account=self.current_account,
            message_type="reply",
            original_message=message,
            on_sent=on_reply_sent
        )
        
    except Exception as e:
        logger.error(f"è¿”ä¿¡å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
        messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"è¿”ä¿¡ç”»é¢ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n{e}")
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè£…

### åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/test_compose_window.py` (15ãƒ†ã‚¹ãƒˆ)

```python
class TestComposeWindow(unittest.TestCase):
    """ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    def test_compose_window_initialization(self):
        """ãƒ¡ãƒ¼ãƒ«ä½œæˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        # æ–°è¦ãƒ»è¿”ä¿¡ãƒ»è»¢é€ã®å„ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–ç¢ºèª
        
    def test_reply_forward_logic(self):
        """è¿”ä¿¡ãƒ»è»¢é€ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ"""
        # ä»¶åç”Ÿæˆã€å¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆä½œæˆã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç¶™æ‰¿
        
    def test_attachment_functionality(self):
        """æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"""
        # ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã€å‰Šé™¤ã€ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®šã€ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        
    def test_html_text_conversion(self):
        """HTML/ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ãƒ†ã‚¹ãƒˆ"""
        # åŒæ–¹å‘å¤‰æ›ã€ä¾˜ã³å¯‚ã³ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        
    def test_message_validation(self):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼ãƒ†ã‚¹ãƒˆ"""
        # å®›å…ˆã€ä»¶åã€æœ¬æ–‡ã®æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ç¢ºèª
```

### æ©Ÿèƒ½åˆ¥ãƒ†ã‚¹ãƒˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `test_compose_functionality.py`

```bash
ğŸŒ¸ WabiMail ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
==================================================
âœ… ComposeWindow ã‚³ã‚¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ  
âœ… è¿”ä¿¡ãƒ»è»¢é€ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
âœ… æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
âœ… HTML/ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ãƒ†ã‚¹ãƒˆ

ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ: 5/5 ãƒ†ã‚¹ãƒˆæˆåŠŸ
ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼
```

### ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
**ãƒ•ã‚¡ã‚¤ãƒ«**: `demo_compose_window.py`

```python
class ComposeWindowDemo:
    """ãƒ¡ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½ãƒ‡ãƒ¢ã‚¯ãƒ©ã‚¹"""
    
    def _demo_new_message(self):
        """æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ‡ãƒ¢"""
        
    def _demo_reply(self):
        """è¿”ä¿¡ãƒ‡ãƒ¢"""
        
    def _demo_forward(self):
        """è»¢é€ãƒ‡ãƒ¢ï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä»˜ãï¼‰"""
        
    def _demo_with_attachment(self):
        """æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ä»˜ããƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¢"""
        
    def _demo_html_message(self):
        """HTMLãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¢"""
```

---

## ğŸ“ˆ å®Ÿè£…æˆæœ

### æ©Ÿèƒ½çš„æˆæœ
- âœ… **åŒ…æ‹¬çš„ãƒ¡ãƒ¼ãƒ«ä½œæˆ**: æ–°è¦ãƒ»è¿”ä¿¡ãƒ»è»¢é€ãƒ»HTMLå¯¾å¿œ
- âœ… **æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†**: ãƒãƒ«ãƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å‰Šé™¤
- âœ… **è‡ªå‹•æ©Ÿèƒ½**: ä¸‹æ›¸ãä¿å­˜ãƒ»æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆãƒ»å¼•ç”¨ç”Ÿæˆ
- âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ»å…¥åŠ›æ¤œè¨¼

### æŠ€è¡“çš„æˆæœ
- âœ… **SMTPçµ±åˆ**: æ—¢å­˜ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹é€£æº
- âœ… **éåŒæœŸå‡¦ç†**: UIãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„é€ä¿¡å‡¦ç†
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- âœ… **æ‹¡å¼µæ€§**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å¯¾å¿œå¯èƒ½ãªè¨­è¨ˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
- âœ… **ä¾˜ã³å¯‚ã³ä½“é¨“**: é™ã‹ã§ç¾ã—ã„ãƒ¡ãƒ¼ãƒ«ä½œæˆç’°å¢ƒ
- âœ… **ç›´æ„Ÿçš„æ“ä½œ**: è‡ªç„¶ãªæ“ä½œãƒ•ãƒ­ãƒ¼
- âœ… **é›†ä¸­ç’°å¢ƒ**: é‚ªé­”ã«ãªã‚‰ãªã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- âœ… **åŠ¹ç‡æ€§**: è‡ªå‹•ä¿å­˜ãƒ»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

---

## ğŸ”„ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

```python
# ç”Ÿç”£æ€§å‘ä¸Šã®ãŸã‚ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
def _setup_key_bindings(self):
    """ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š"""
    # Ctrl+Enter ã§é€ä¿¡
    self.window.bind('<Control-Return>', lambda e: self._send_message())
    
    # Ctrl+S ã§ä¸‹æ›¸ãä¿å­˜
    self.window.bind('<Control-s>', lambda e: self._save_draft())
    
    # Escape ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    self.window.bind('<Escape>', lambda e: self._cancel_compose())
    
    # Ctrl+O ã§æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ 
    self.window.bind('<Control-o>', lambda e: self._add_attachment())
```

---

## ğŸŒ¸ ä¾˜ã³å¯‚ã³ç¾å­¦ã®å®Ÿç¾

### è¦–è¦šçš„èª¿å’Œ
- **ç´”ç™½ã®èƒŒæ™¯**: å¿ƒã‚’è½ã¡ç€ã‹ã›ã‚‹æ¸…æ½”ãªç’°å¢ƒ
- **å¢¨è‰²ã®æ–‡å­—**: èª­ã¿ã‚„ã™ãç¾ã—ã„æ–‡å­—è‰²
- **ç¹Šç´°ãªå¢ƒç•Œç·š**: æ§ãˆã‚ã§ä¸Šå“ãªåŒºåˆ‡ã‚Š
- **è‡ªç„¶ãªè‰²èª¿**: ç›®ã«å„ªã—ã„å’Œã®è‰²å½©

### æ“ä½œã®é™å¯‚æ€§
- **æ§ãˆã‚ãªãƒœã‚¿ãƒ³**: æ©Ÿèƒ½çš„ã§ã‚ã‚ŠãªãŒã‚‰ç¾ã—ã„
- **è‡ªç„¶ãªé…ç½®**: ç›´æ„Ÿçš„ãªæ“ä½œãƒ•ãƒ­ãƒ¼
- **é™ã‹ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: é‚ªé­”ã«ãªã‚‰ãªã„çŠ¶æ…‹è¡¨ç¤º
- **ä½™ç™½ã®ç¾**: é©åˆ‡ãªç©ºé–“ã«ã‚ˆã‚‹è¦–è¦šçš„ä¼‘æ¯

### å¿ƒã‚’è¾¼ã‚ãŸä½“é¨“
- **å¼•ç”¨ã®ç¾**: è¿”ä¿¡æ™‚ã®ä¸å¯§ãªå¼•ç”¨å½¢å¼
- **æ·»ä»˜ã®é…æ…®**: ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®ç¾ã—ã„è¡¨ç¤º
- **ä¿å­˜ã®å®‰å¿ƒ**: è‡ªå‹•ä¿å­˜ã«ã‚ˆã‚‹å®‰å…¨æ€§
- **é€ä¿¡ã®å„€å¼**: ç¢ºèªã‹ã‚‰é€ä¿¡ã¾ã§ã®æµã‚Œ

---

## ğŸ‰ Task 9 å®Œäº†

**ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½**ã®å®Ÿè£…ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- âœ… **Task 9**: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ â†’ **å®Œäº†**
- ğŸ”œ **Task 10**: è¨­å®šç”»é¢å®Ÿè£… - G004ä¸€èˆ¬è¨­å®šã¨ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ†ãƒ¼ãƒé©ç”¨
- ğŸ”œ **Task 11**: ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– - è¨­å®šãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®æš—å·åŒ–ä¿å­˜

ä¾˜ã³å¯‚ã³ã®ç¾å­¦ã«åŸºã¥ã„ãŸã€å¿ƒã‚’è¾¼ã‚ãŸãƒ¡ãƒ¼ãƒ«ä½œæˆä½“é¨“ã‚’å®Ÿç¾ã§ãã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é™ã‹ã§ç¾ã—ã„ç’°å¢ƒã§ã€å¤§åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸å¯§ã«ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

**ğŸŒ¸ é™å¯‚ã®ä¸­ã®ç¾ã—ã•ã‚’è¿½æ±‚ã—ã¦**

**WabiMailé–‹ç™ºãƒãƒ¼ãƒ **  
*2025å¹´7æœˆ1æ—¥*